@using System.Globalization;
@model List<DoAnTotNghiep.Models.TTCN>
@{
    ViewData["Title"] = "ThanhToanCongNo";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var stt = 1;
}
@{
    CultureInfo cul = CultureInfo.GetCultureInfo("vi-VN"); // try with "en-US"
    string a = double.Parse("12345").ToString("#,###", cul.NumberFormat);
}
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<div class="l-navbar" id="nav-bar">
    <nav class="nav">
        <div>
            <a href="#" class="nav_logo m-l--10">
                <img src="~/images/logo.png" width="35px" height="35px" alt="">
                <span class="nav_logo-name">Quản lý sinh viên</span>
            </a>
            <div class="nav_list">
                <a href="@Url.Action("News", "Home")" class="nav_link">
                    <i title="Bảng tin" class='bx bx-home-alt-2'></i>
                    <span class="nav_name">Bảng tin</span>
                </a>
                <a href="@Url.Action("ChiaSeBieuMau", "Home")" class="nav_link">
                    <i title="Chia sẻ" class='bx bx-message-square-detail nav_icon'></i>
                    <span class="nav_name">Chia sẻ</span>
                </a>
                <div class="dropdown">
                    <button class="dropbtn">
                        <a href="@Url.Action("KetQuaHocTap", "Home")" class="nav_link">
                            <i title="Kết quả học tập" class='bx bx-clipboard'></i>
                            <span class="nav_name">Kết quả học tập</span>
                        </a>
                    </button>
                    <div class="dropdown-contnet">
                        <a href="@Url.Action("KetQuaThi", "Home")"><i title="Kết quả thi" class='bx bx-task'></i> Kết quả thi</a>
                        <a href="@Url.Action("TBChungTichLuy", "Home")"><i title="TB chung tích lũy" class='bx bx-task'></i> TB chung tích lũy</a>
                        <a href="@Url.Action("TBChungHocKy", "Home")"><i title="TB chung học kỳ" class='bx bx-task'></i> TB chung học kỳ</a>
                        <a href="@Url.Action("XetThuTotNghiep", "Home")"><i title="Xét thử tốt nghiệp" class='bx bx-task'></i> Xét thử tốt nghiệp</a>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="dropbtn">
                        <a href="@Url.Action("ThoiKhoaBieu", "Home")" class="nav_link">
                            <i title="Thời khóa biểu" class='bx bx-time-five'></i>
                            <span class="nav_name">Thời khóa biểu</span>
                        </a>
                    </button>
                    <div class="dropdown-contnet">
                        <a href="@Url.Action("LichGiangDay", "Home")"><i title="Lịch giảng dạy" class='bx bx-timer nav_icon_con'></i> Lịch giảng dạy</a>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="dropbtn">
                        <a href="@Url.Action("XemLichThi", "Home" )" class="nav_link">
                            <i title="Lịch thi" class='bx bx-calendar'></i>
                            <span class="nav_name">Lịch thi</span>
                        </a>
                    </button>
                    <div class="dropdown-contnet">
                        <a href="@Url.Action("KeHoachThi", "Home")"><i title="Kế hoạch thi theo lớp" class='bx bx-calendar-check'></i> Kế hoach thi theo lớp</a>
                    </div>
                </div>
                <a href="@Url.Action("LopHoc", "Home" )" class="nav_link">
                    <i title="Lớp Học" class='bx bxs-school'></i>
                    <span class="nav_name">Lớp học</span>
                </a>
                <a href="@Url.Action("CaNhan", "Home" )" class="nav_link active">
                    <i title="Cá nhân" class='bx bx-user nav_icon'></i>
                    <span class="nav_name">Cá nhân</span>
                </a>
                <div class="dropdown">
                    <button class="dropbtn">
                        <a href="@Url.Action("DangKyHP", "Home" )" class="nav_link">
                            <i title="Đăng ký học phần" class='bx bx-bookmark nav_icon'></i>
                            <span class="nav_name">Đăng ký học phần</span>
                        </a>
                    </button>
                    <div class="dropdown-contnet">
                        <a href="@Url.Action("TinhHinhDangKyHP", "Home")"><i title="Tình hình ĐK học phần" class='bx bxs-bookmark'></i> Tình hình ĐK học phần</a>
                        <a href="#"><i title="ĐK học 2 chương trình" class='bx bx-bookmarks'></i> ĐK học 2 chương trình</a>
                        <a href="#"><i title="Danh sách đăng ký học phần" class='bx bx-bookmarks'></i> Danh sách đăng ký</a>
                        <a href="#"><i title="Kiểm tra tiến độ CT2" class='bx bx-bookmarks'></i> Kiểm tra tiến độ CT2</a>
                        <a href="@Url.Action("KhungChuongTrinh", "Home")"><i title="Khung chương trình" class='bx bxs-book-bookmark'></i> Khung chương trình</a>
                        <a href="@Url.Action("KhungChuongTrinhKy", "Home")"><i title="Khung chương trình (Kỳ)" class='bx bxs-book-bookmark'></i> Khung chương trình (Kỳ)</a>
                    </div>
                </div>
                <a href="@Url.Action("DanhGiaRenLuyen", "Home" )" class="nav_link">
                    <i title="Đánh giá rèn luyện" class='bx bx-bar-chart-alt-2 nav_icon'></i>
                    <span class="nav_name">Đánh giá rèn luyện</span>
                </a>
                @*                <a href="#" class="nav_link">
                <i class='bx bx-log-out nav_icon'></i>
                <span class="nav_name">Đăng xuất</span>
                </a>*@
            </div>
        </div>
    </nav>
</div>
<!--Container Main start-->
<div class="border-page">
    <div class="Bang-tin">
        <p class="title-page">Thanh Toán công nợ</p>
        <div class="title-line"></div>
        <div class="TBChungTL">
            <div class="infor-student">
                <div class="Gap-txt">
                    <div class="d-flex">
                        <div class="">
                            <p>Họ và tên sinh viên:</p>
                            <p>Mã sinh viên:</p>
                            <p>Lớp:</p>
                        </div>
                        <div class="p-l-30">
                            <p><strong>@ViewBag.StudentInfo.Fullname</strong></p>
                            <p><strong>@ViewBag.StudentInfo.Usercode</strong></p>
                            <p><strong>@ViewBag.StudentInfo.Classname</strong></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="txt-notic">
                <strong class="txt-clr-red">Chú ý!:</strong>
                <p>- Nếu chưa thanh toán các khoản phí dưới đây, Tài khoản sẽ bị Khóa một số chức năng.</p>
                <p>- Nếu Số tiền chưa Thanh toán lớn hơn Số dư tài khoản, bạn phải bổ sung tiền vào tài khoản.</p>
            </div>
            <div class="table-TBChungTL">
                <table style="width:100% ;padding-left: 4px">
                    <form>
                    <tr>
                        <th style="width:3%;">STT</th>
                        <th style="width:8%;">Mã khoản thu</th>
                        <th style="width:12%;">Khoản thu</th>
                        <th style="width:5%;">Số tín chỉ</th>
                        <th style="width:8%;">Số tiền</th>
                        <th style="width:6%;">Trạng thái</th>
                        <th style="width:0%;"><input id="chkall" type="checkbox"></th>
                    </tr>
                    <tbody>
                            @foreach (var item in Model)
                            {
                            <tr>
                                <td>@(stt++)</td>
                                <td>@item.ClassCode</td>
                                <td>@item.ModulesName</td>
                                <td>@item.Credits</td>
                                <td class="cost">@item.Costs</td>
                                <td style="color:lightcoral"><strong>Chưa nộp</strong></td>
                                    @if (item.Credits != 0)
                                    {
                                    <td><div class="p-l-2"><input type="checkbox" value="@item.id" aria-label="Checkbox for following text input"></div></td>
                                    }

                                    else
                                    {
                                        string b = 'k' + item.id.ToString();
                                    <td><div class="p-l-2"><input type="checkbox" value="@(b)" aria-label="Checkbox for following text input"></div></td>
                                    }
                            </tr>
                            }
                            
                        <tr class="txt-clr-red">
                            <td colspan="4">Tổng số tiền chưa thanh toán:</td>
                            <td colspan="3" id="ctt"><sub> (vnđ)</sub></td>
                        </tr>
                        <tr class="txt-clr-red">
                            <td colspan="4">Số dư tài khoản:</td>
                            <td colspan="3">@ViewBag.StudentInfo.Amount.ToString("#,###", cul.NumberFormat)<sub> (vnđ)</sub></td>
                        </tr>
                        <tr class="txt-clr-red">
                            <td colspan="3">Số tiền hệ thống sẽ trừ:</td>
                            <td id="htst"></td>
                            <td id="vnd" colspan="4"></td>
                        </tr>
                    </tbody>
                    </form>
                </table>
                <button id="thanhtoan" type="submit" class="button m-t-12 m-l-16">Thanh toán</button>
            </div>
            <div class="table-TBChungTL m-t-10">
                <table style="width:100% ;padding-left: 4px">
                    <tr>
                        <td colspan="16">
                            <strong class="fs-11">
                                Danh sách những khoản công nợ đã thanh toán
                            </strong>
                        </td>
                    </tr>
                    <tr>
                        <th style="width:2%;">STT</th>
                        <th style="width:14%;">Mã khoản thu</th>
                        <th>Khoản thu</th>
                        <th style="width:10%;">Số tín chỉ</th>
                        <th style="width:16%;">Số tiền <sub>(vnđ)</sub></th>
                        <th style="width:12%;">Trang thái</th>
                    </tr>
                    <tbody>
                        @if (ViewBag.StudentAmount != null)
                        {
                            var stt2 = 1;
                            @foreach (var item in (List<TTCN>)ViewBag.StudentAmount)
                            {
                                <tr>
                                    <td>@(stt2++)</td>
                                    <td>@item.ClassCode</td>
                                    <td>@item.ClassName</td>
                                    <td>@item.Credits</td>
                                    <td>@item.Costs</td>
                                    <td style="color:blue"><strong>Đã nộp</strong></td>
                                </tr>
                            }

                        }
                        else
                        {
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        $("#thanhtoan").click(function () {
            let id = "";
            $("input[type=checkbox]:checked").each(function () {
                if ($(this).parent().prop('nodeName') != "TH") {
                    id += $(this).val() + ',';
                }
            })
            $.ajax({
                url: "/Home/PostTTCN",
                method: "POST",
                data: { id },
                success: function (rs) {
                    if (rs == "Y") {
                        toastr.success("Thành công");
                        setTimeout(function(){
                            window.location = "/Home/ThanhToanCongNo";
                        }, 2000);
                    } else if (rs == "S") {
                        toastr.warning("Số dư không đủ");
                    } else {
                        toastr.error("Không thành công");
                    }
                }
            })
        })
        debugger
        var s = 0;
        $(".cost").each(function () {
            s += parseInt($(this).html());
        })
        $("#ctt").html(s);
        $("input[type=checkbox]").change(function () {
            debugger
            let tong = 0;
            $("input[type=checkbox]:checked").each(function () {
                if ($(this).parent().prop('nodeName') != "TH") {
                    tong += parseInt($(this).parent().parent().parent().find('.cost').html());
                }
            })
            $("#htst").html(tong);
            DocTienBangChu(tong);
        })
        $("#chkall").change(function () {
            if ($(this).prop("checked") == true) {
                $("input[type=checkbox]").each(function () {
                    if ($(this).parent().prop('nodeName') != "TH") {
                        $(this).prop("checked", true);
                    }
                })
            } else {
                $("input[type=checkbox]:checked").each(function () {
                    if ($(this).parent().prop('nodeName') != "TH") {
                        $(this).prop("checked", false);
                    }
                })
            }
            let tong = 0;
            $("input[type=checkbox]:checked").each(function () {
                if ($(this).parent().prop('nodeName') == "DIV") {
                    tong += parseInt($(this).parent().parent().parent().find('.cost').html());
                }
            })
            $("#htst").html(tong);
            DocTienBangChu(tong);
        })
    })
    var ChuSo = new Array(" không ", " một ", " hai ", " ba ", " bốn ", " năm ", " sáu ", " bảy ", " tám ", " chín ");
    var Tien = new Array("", " nghìn", " triệu", " tỷ", " nghìn tỷ", " triệu tỷ");
    function DocSo3ChuSo(baso) {
        var tram;
        var chuc;
        var donvi;
        var KetQua = "";
        tram = parseInt(baso / 100);
        chuc = parseInt((baso % 100) / 10);
        donvi = baso % 10;
        if (tram == 0 && chuc == 0 && donvi == 0) return "";
        if (tram != 0) {
            KetQua += ChuSo[tram] + " trăm ";
            if ((chuc == 0) && (donvi != 0)) KetQua += " linh ";
        }
        if ((chuc != 0) && (chuc != 1)) {
            KetQua += ChuSo[chuc] + " mươi";
            if ((chuc == 0) && (donvi != 0)) KetQua = KetQua + " linh ";
        }
        if (chuc == 1) KetQua += " mười ";
        switch (donvi) {
            case 1:
                if ((chuc != 0) && (chuc != 1)) {
                    KetQua += " mốt ";
                }
                else {
                    KetQua += ChuSo[donvi];
                }
                break;
            case 5:
                if (chuc == 0) {
                    KetQua += ChuSo[donvi];
                }
                else {
                    KetQua += " lăm ";
                }
                break;
            default:
                if (donvi != 0) {
                    KetQua += ChuSo[donvi];
                }
                break;
        }
        return KetQua;
    }
    function DocTienBangChu(SoTien) {
        var lan = 0;
        var i = 0;
        var so = 0;
        var KetQua = "";
        var tmp = "";
        var ViTri = new Array();
        if (SoTien < 0) return "Số tiền âm !";
        if (SoTien == 0) return "Không đồng !";
        if (SoTien > 0) {
            so = SoTien;
        }
        else {
            so = -SoTien;
        }
        if (SoTien > 8999999999999999) {
            //SoTien = 0;
            return "Số quá lớn!";
        }
        ViTri[5] = Math.floor(so / 1000000000000000);
        if (isNaN(ViTri[5]))
            ViTri[5] = "0";
        so = so - parseFloat(ViTri[5].toString()) * 1000000000000000;
        ViTri[4] = Math.floor(so / 1000000000000);
        if (isNaN(ViTri[4]))
            ViTri[4] = "0";
        so = so - parseFloat(ViTri[4].toString()) * 1000000000000;
        ViTri[3] = Math.floor(so / 1000000000);
        if (isNaN(ViTri[3]))
            ViTri[3] = "0";
        so = so - parseFloat(ViTri[3].toString()) * 1000000000;
        ViTri[2] = parseInt(so / 1000000);
        if (isNaN(ViTri[2]))
            ViTri[2] = "0";
        ViTri[1] = parseInt((so % 1000000) / 1000);
        if (isNaN(ViTri[1]))
            ViTri[1] = "0";
        ViTri[0] = parseInt(so % 1000);
        if (isNaN(ViTri[0]))
            ViTri[0] = "0";
        if (ViTri[5] > 0) {
            lan = 5;
        }
        else if (ViTri[4] > 0) {
            lan = 4;
        }
        else if (ViTri[3] > 0) {
            lan = 3;
        }
        else if (ViTri[2] > 0) {
            lan = 2;
        }
        else if (ViTri[1] > 0) {
            lan = 1;
        }
        else {
            lan = 0;
        }
        for (i = lan; i >= 0; i--) {
            tmp = DocSo3ChuSo(ViTri[i]);
            KetQua += tmp;
            if (ViTri[i] > 0) KetQua += Tien[i];
            if ((i > 0) && (tmp.length > 0)) KetQua += ','; //&& (!string.IsNullOrEmpty(tmp))
        }
        if (KetQua.substring(KetQua.length - 1) == ',') {
            KetQua = KetQua.substring(0, KetQua.length - 1);
        }
        KetQua = KetQua.substring(1, 2).toUpperCase() + KetQua.substring(2);
        $("#vnd").html(KetQua + " đồng"); //.substring(0, 1);//.toUpperCase();// + KetQua.substring(1);
    }
</script>